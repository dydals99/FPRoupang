<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 

 <mapper namespace="com.edu.springboot.jdbc.CartService">
 
 	<!-- 1. 장바구니 추가 -->
	<insert id="insertCart">
		insert into cart 
		values (cart_seq.nextval, #{member_idx}, #{product_idx}, #{c_total})
	</insert>
	
	<!-- 2. 장바구니 목록 -->
	<select id="getCartList" resultType="com.edu.springboot.jdbc.CartDTO">
		SELECT cart_idx, m.email, p_title, pi_delifee, pi_price, pi_discount, c_want_buy,
			p_title_image
		FROM cart
		JOIN product p ON p.idx = c.product_idx
		JOIN bot_category bc ON bc.idx = p.bot_idx
		JOIN product_info pi ON bc.idx = pi.bot_idx
		join member m on c.member_idx = m.member_idx
		where email = #{email}
	</select>
	
	<!-- 3. 장바구니 전체 금액 -->
	<select id="sumMoney" resultType="int">
		select NVL(SUM(pi_price * c_total), 0) money
		from cart c, product p
		where c.product_idx = p.idx and c.user_id = #{userId}
	</select>
	
	<!-- 4. 장바구니 수량 수정 -->
	<update id="modifyCart">
		update cart 
		set c_total = #{c_total}
		where user_id = #{userId}
		and p_title = #{p_title}
	</update>
	
	<!-- 5. 장바구니 삭제 -->
	<delete id="deleteCart">
		delete from cart where cart_idx = #{cart_idx}
	</delete>
	
	<!-- 6. 장바구니에 동일한 상품 레코드 확인 -->
	<select id="checkCart" resultType="com.edu.springboot.jdbc.CartDTO">
		select count(*) from cart c
		<!-- where member_idx = #{member_idx} and product_idx = #{product_idx} -->
		join product p on c.product_idx = p.idx
		join member m on c.member_idx = m.idx
		where c.product_idx = #{product_idx} and email = ${email}
	</select>
	
	<!-- 7. 장바구니에 동일한 상품이 존재하면 수정 -->
	<update id="updateCart">
		update cart
		set c_total = c_total + #{c_total}
		where member_idx = #{member_idx}
		and product_idx = #{product_idx}
	</update>
 </mapper>